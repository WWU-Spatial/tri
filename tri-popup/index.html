
<!DOCTYPE html>
<html>
	<head>
		<!-- All SS will get compiled into one file at production time -->
		<link rel="stylesheet" href="../assets/css/jquery-ui-1.10.3.core.css" />
		<link rel="stylesheet" href="../assets/css/jquery-ui-1.10.3.widgets.css" />
		<link rel="stylesheet" href="../assets/css/jquery-ui-1.10.3.tabs.css" />
		<!-- <link rel="stylesheet" href="http://myweb.wwu.edu/lesserj/tri/leaflet/assets/css/info_widget.css" /> -->

		<!-- All JS will get compiled into one file at production time -->
		<script type="text/javascript" src="../assets/js/jquery-1.10.0.js"></script>
		<script type="text/javascript" src="../assets/js/jquery-ui-1.10.3.core.js"></script>
		<script type="text/javascript" src="../assets/js/jquery-ui-1.10.3.widget.js"></script>
		<script type="text/javascript" src="../assets/js/jquery-ui-1.10.3.tabs.js"></script>
		<!--[if lt IE 9]>
			<script type="text/javascript" src="../assets/js/es5-shim.min.js"></script>
		<![endif]-->
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
		
		<style>
			#facility_tabs{
				width: 325px;
				height:400px;
				border: 1px solid red;
				font-size: 0.8em;
			}
			
			#chemical_tab{
				padding: 0;
			}
			
			#chemicalYearToggle {
				position: relative;
				height: 30px;
				text-align: center;
				padding: 0;
				color: #fff;
				text-align: center;
				background-color: rgba(2, 2, 2, 0.9);
			}
			
		
			
			.arrow-right {
				width: 0; 
				height: 0; 
				border-top: 13px solid transparent;
				border-bottom: 13px solid transparent;
				border-left: 13px solid #fff;
				position: absolute;
				right: 114px;
				top:0px;
				cursor: pointer;


			}
			
			.arrow-left {
				width: 0; 
				height: 0; 
				border-top: 13px solid transparent;
				border-bottom: 13px solid transparent; 
				border-right:13px solid #fff; 
				position: absolute;
				left: 114px;
				top:0px;
				cursor: pointer;


			}
			
			.year-label{
				width: 50%;
				margin: 0 auto;
				font-size: 1.8em;
				font-family: 'AlternateGothicLTNo3Regular',Arial, sans-serif;
				font-weight: bold;
				
			}
				
			
			
			.graph {
				width: 300px;
				height: 150px;
				border: 1px dashed blue;
				margin-left: auto;
				margin-right: auto;
				clear: both;
				margin-top: 7px;
				margin-bottom: 7px;
			}
			
			.list {
				height: 324px;
				overflow-y: auto;
			}
			
			.chemical_row{
				line-height: 1.4em;
				margin: 0.5em 0.2em;
				padding: 0.3em;
				border: 1px solid #eee;
			}
			
			.chemical_row:hover {
				background-color: #F8F8F8;
				cursor: pointer;
			}
			
			.noChart{
				width: 100%;
				text-align: center;
				height: 100%;
				line-height: 140px;
				font-size: 20px;
				margin: 0 auto;
			}
			
		</style>
	</head>
	<body>
		<div id="facility_tabs">
			<ul>
				<li>
					<a href="#general_tab">General</a>
				</li>
				<li>
					<a href="#chemical_tab">Chemical</a>
				</li>
				<li>
					<a href="#industry_tab">Industry</a>
				</li>
			</ul>
			<div id="general_tab" class="tab">
				<div id="info_title">
					<strong></strong>
				</div>
				<div class='graph'></div>
				<div id='info_industry'></div>
				<div id='info_address'></div>
				<div id='info_contact'></div>
				<div class="zoom_to">
					Zoom to Facility
				</div>
			</div>
			<div id="chemical_tab" >
				<div id="chemicalYearToggle" >
					<div id="window_left" class="arrow-left"></div>
					<div id="window_year" class="year-label"></div>
					<div id="window_right" class="arrow-right"></div>
				</div>
				<div id="chemicalList" class="list"></div>
			</div>
			<div id="industry_tab" class="tab"></div>
		</div>

		<script>
			(function() {
				app = {};
				app.currentYear = 2010;
				app.chartData = {};
				app.maxYear = 2010;
				app.minYear = 2001;

				// load google api
				google.load("visualization", "1", {
					packages : ["corechart"]
				});
				google.setOnLoadCallback(getData);

				// Activate tabs on popup
				$("#facility_tabs").tabs();

				//Download sample data
				var url = 'http://140.160.114.197/api/v3/facility/134330.json'; //Max Data
				// var url = 'http://140.160.114.197/api/v3/facility/149233.json'; //Min Data
				// var url = 'http://140.160.114.197/api/v3/facility/110280.json'; //No Data
				function getData(){
					
					//Set info window year to current year
					document.getElementById('window_year').innerHTML = app.currentYear;
					
					$.ajax({
						dataType : "json",
						url : url,
						success : function(facility_record) {
							loadChart(facility_record);
							parseFacility(facility_record);
							parseChemicals(facility_record)
							initChemListListener();
							initYearChangers(facility_record);
						}
					});
				}	
				
				function loadChart(facility_record){		
					// create chart data
					if (!facility_record.Emissions || Object.keys(facility_record.Emissions).length === 1){
						// no years of data so set the chart area to say no chart
						$('.graph').html('<p class="noChart">Not enough data for a chart</p>');
					} else {	
						var data;
						var chart_data = [['Year', 'Total Pounds Released', 'Risk']];
						var chart = new google.visualization.LineChart($('.graph')[0]);
						$.each(facility_record.Emissions, function(k,v){
							chart_data.push([k, v.TotalPounds, v.TotalScore]);
						});
						
						data = google.visualization.arrayToDataTable(chart_data)
						//set the chart properties
						options = {
							title : 'Facility Performance',
							hAxis:{
								gridlines: {
									color: '#333', 
									count: 10
								}
							},
							series: {
					            0: {
					                targetAxisIndex: 0
					            },
					            1: {
					                targetAxisIndex: 1
					            }
					        },
					        vAxes: {
					            0: {
					                textStyle:{color: 'blue'},
					                label: 'Total Pounds Released'
					            },
					            1: {
					            	textStyle:{color: 'red'},
					                label: 'Risk'
					            }
					        },

						};
						chart.draw(data, options);
						app.chart = chart;
					}
				}
	
				function parseFacility(facility_record) {
					document.getElementById('info_title').innerHTML = '<STRONG>' + facility_record['Name'] + '</STRONG>';
					document.getElementById('info_industry').innerHTML = 'Industry: ' + facility_record['NAICS1']['name'];
					document.getElementById('info_address').innerHTML = '<p>' + facility_record['Street'] + '<br />' + facility_record['City'] + ' ' + facility_record['State'] + ', ' + facility_record['ZIPCode'] + '<br />' + facility_record['Latitude'] + ' ' + facility_record['Longitude'] + '</p>';
					document.getElementById('info_contact').innerHTML = '<p>' + facility_record['PublicContactName'] + '<br />' + facility_record['PublicContactPhone'].replace(/(\d\d\d)(\d\d\d)(\d\d\d\d)/, '($1) $2-$3') + '</p>';
				}
				
				function parseChemicals(facility_record){
					var chemList = document.getElementById('chemicalList');
					try {
						var emissions = facility_record['Emissions'][app.currentYear]['Submissions'];
					} catch(err) {
						var emissions = 'NoData';
					}
					
					if (emissions != 'NoData') {
						emissions.sort(function(a, b) {
							//http://stackoverflow.com/questions/5435228/sort-an-array-with-arrays-in-it-by-string
							//Returns results high-to-low.  Change return 1 to -1 and return -1 to 1 to reverse
							if (a['Score'] < b['Score'])
								return 1;
							if (a['Score'] > b['Score'])
								return -1;
							return 0;
						});

						for (emission in emissions) {
							var div = document.createElement('div');
							div.setAttribute('class', 'chemical_row');
							div.setAttribute('id', 'cas' + emissions[emission]['CASNumber'])
							div.innerHTML = emissions[emission]['Chemical'] + '<br />' + 'Pounds: ' + emissions[emission]['Pounds'].toFixed(2) + ' Risk: ' + emissions[emission]['Score'].toFixed(2) + '<div id="inf' + emissions[emission]['CASNumber'] + '" class="chemical_details"></div>';
							chemList.appendChild(div);
						}
					} else {
						chemList.innerHTML = 'No Chemical Air Releases in ' + app.currentYear;
					}
				}
				
				function initChemListListener(){
					//Event Listener for chemical list click
					$("#chemicalList").click(function(e) {
						var target = $(e.target);
	
						// Check that they clicked on a chemical row and not the container
						if (target.hasClass("chemical_row")) {
							var casNum = (e.target.id).substring(3, e.target.id.length);
							var chem_details = target.children('.chemical_details');
							
							//Check to see if data was downloaded during a previous click
							//If not, download data
					  		if (!target.hasClass("data_loaded")){
					  			//Position from top of chemical list to scroll list to
					  			var scrollto = $("#chemicalList").scrollTop() + chem_details.position().top - 120;
					  			
					  			//Get the clicked chemical from the api and add "data_loaded" class to prevent loading again on future clicks
					  			getChem(casNum);
					  			target.addClass("data_loaded");
					  			chem_details.show();
								
								//Scroll chemical list window so chemical of interest is at top
					  			$("#chemicalList").animate({
								    scrollTop: (scrollto +'px')},'slow');
					  			
					  		} else {
					  			//If data already loaded, hide or show the chemical details depending on the current view state
					  			
					  			if (chem_details.is(":visible")){
					  				chem_details.hide();
					  			} else {
					  				chem_details.show();
					  			}
					  		}
						}
					})
				}
				
				function getChem(casNum){
					var url = 'http://140.160.114.197/api/v3/chemical/' + casNum + '.json';
					$.ajax({
						dataType : "json",
						url : url,
						success : function(data){
							parseChem(casNum, data)
						}
					});
				}
				
				function parseChem(casNum, data){
					var html = '';

					// Metal
					html += "<br /><strong>Metalic: </strong>";
					if (data.Metal == "TRUE") {
						html += 'This chemical is a metal';
					} else {
						html += 'This chemical is not a metal';
					}
					
					// Carcinogen
					html += "<br /><br /><strong>Cancer: </strong>";
					if (data.ToxicityClassInhale == "cancer"  && data.ToxicityClass == "cancer") {
						html += "This chemical is carcinogenic through both the oral and inhalation pathways";
					} else if (data.ToxicityClassInhale == "non-cancer"  && data.ToxicityClass == "non-cancer") {
						html += "This chemical is not known to be carcinogenic";
					} else if (data.ToxicityClassInhale == "cancer"  && data.ToxicityClass == "non-cancer") {
						html += "This chemical is carcinogenic through the inhalation pathway but not the oral pathway";
					} else if (data.ToxicityClassInhale == "non-cancer"  && data.ToxicityClass == "cancer") {
						html += "This chemical is carcinogenic through the oral pathway but not the inhalation pathway";
					} else {
						html += "Information on cancer causing effects are not available for this chemical";
					}
					
					// Health Effects
					html += "<br /><br /><strong>Other Health Effects: </strong>";
					if (data['Health Effects'] == undefined || data['Health Effects'] == null || data['Health Effects'].length == 0){
						html += "Human health effects have not been identfied for this chemical";
					} else {
						html += 'Identified human health effects include: ';
						if (data['Health Effects'].length == 1){
							html += data['Health Effects'][0];
						} else if (data['Health Effects'].length == 2){
							html += data['Health Effects'][0] + ' and ' +  data['Health Effects'][1];
						} else if (data['Health Effects'].length > 2){
							var text = data['Health Effects'][data['Health Effects'].length-1];
							data['Health Effects'][data['Health Effects'].length-1] = 'and ' + text;
							html += data['Health Effects'].join(', ')
						}
					}
					
					//Federal Register
					html += "<br /><br /><strong>Federal Register: </strong>";
					if (data['Federal Register'] == ""){
						html += "There is no official definition of this chemical in the federal register";
					} else {
						html += data['Federal Register'];
					}
					
					// Aditional Information
					html += "<br /><br /><strong>Additional information: </strong>";
					
					if (data["IRIS"] !== ""){
						html += '<br /><a href="' + data["IRIS"] + '" target="_blank">Integrated Risk Information System (IRIS)</a>';
					}
					if (data["ATSDR"] !== ""){
						html += '<br /><a href="' + data["ATSDR"] + '" target="_blank">Agency for Toxic Substances and Disease Registry (ATSDR)</a>';
					}
					if (data["OPP"] !== ""){
						html += '<br /><a href="' + data["OPP"] + '" target="_blank">Office of Pesticide Programs (OPP)</a>';
					}
					if (data["OPP"] === "" && data["IRIS"] === "" && data["ATSDR"] === ""){
						html += "<br />None available"
					}
					
					//Add html to chemical div
					document.getElementById('inf' + casNum).innerHTML = html;			
				}
				
				function initYearChangers(facility_record){
					$("#window_left").click(function(){
						if (app.currentYear > app.minYear){
							app.currentYear -= 1;
							document.getElementById('window_year').innerHTML = app.currentYear;
							document.getElementById('chemicalList').innerHTML = "";
							parseChemicals(facility_record);
							$("#chemicalList").animate({
								    scrollTop: ('0px')},'fast');
						}
					})
					
					$("#window_right").click(function(){
						if (app.currentYear < app.maxYear){
							app.currentYear += 1;
							document.getElementById('window_year').innerHTML = app.currentYear;
							document.getElementById('chemicalList').innerHTML = "";
							parseChemicals(facility_record);
							$("#chemicalList").animate({
								    scrollTop: ('0px')},'fast');
						}
						
					})
				}

			})();

		</script>
	</body>
</html>
